# Настройка SSL для Docker

Этот документ описывает настройку SSL/TLS для проекта в Docker с использованием IP адреса (без домена).

## Быстрый старт

Для работы с IP адресом используются self-signed SSL сертификаты:

1. Сгенерируйте SSL сертификат для вашего IP адреса:
```bash
# Используйте ваш IP адрес (по умолчанию: 45.10.41.250)
./nginx/generate-ssl.sh 45.10.41.250

# Или для другого IP:
./nginx/generate-ssl.sh YOUR_IP_ADDRESS
```

2. Запустите Docker Compose:
```bash
docker-compose up -d
```

3. Приложение будет доступно по HTTPS:
   - HTTP: `http://YOUR_IP_ADDRESS` (автоматически перенаправляет на HTTPS)
   - HTTPS: `https://YOUR_IP_ADDRESS`
   - Также работает: `https://localhost` и `https://127.0.0.1`

**Важно:** 
- Браузер покажет предупреждение о небезопасном соединении для self-signed сертификатов. Это нормально.
- Нажмите "Продолжить" или "Advanced" → "Proceed to [IP]" в браузере
- Self-signed сертификаты обеспечивают шифрование трафика, но не проверяются доверенными центрами сертификации

## Работа с IP адресом

**Примечание:** Let's Encrypt не работает с IP адресами, только с доменами. Для работы с IP адресом используются self-signed сертификаты.

### Генерация сертификата для IP адреса

Скрипт `generate-ssl.sh` автоматически создает сертификат с поддержкой:
- Указанного IP адреса
- localhost (127.0.0.1)
- DNS имени localhost

```bash
# Генерация для конкретного IP
./nginx/generate-ssl.sh 45.10.41.250

# Сертификат будет действителен для:
# - IP: 45.10.41.250
# - IP: 127.0.0.1
# - DNS: localhost
```

### Обновление сертификата

Self-signed сертификаты действительны 365 дней. Для обновления:

```bash
# Просто запустите скрипт заново
./nginx/generate-ssl.sh YOUR_IP_ADDRESS
docker-compose restart nginx
```

## Структура директорий

```
nginx/
├── nginx.conf          # Конфигурация nginx с SSL
├── ssl/                # SSL сертификаты
│   ├── cert.pem        # Сертификат
│   └── key.pem         # Приватный ключ
└── generate-ssl.sh     # Скрипт генерации self-signed сертификатов
```

## Настройка Django для HTTPS

Убедитесь, что в `settings.py` включены настройки для работы через прокси:

```python
# settings.py
SECURE_PROXY_SSL_HEADER = ('HTTP_X_FORWARDED_PROTO', 'https')
SESSION_COOKIE_SECURE = True
CSRF_COOKIE_SECURE = True
```

## Проверка SSL

После настройки проверьте SSL:

1. Откройте `https://YOUR_IP_ADDRESS` в браузере
2. Браузер покажет предупреждение - нажмите "Продолжить" или "Advanced" → "Proceed to [IP]"
3. Проверьте, что соединение зашифровано (замочек в адресной строке)

**Примечание:** Онлайн-инструменты проверки SSL (ssllabs.com, sslchecker.com) не работают с IP адресами, только с доменами.

## Устранение проблем

### Ошибка: "SSL certificate not found"
- Убедитесь, что файлы `cert.pem` и `key.pem` существуют в `nginx/ssl/`
- Проверьте права доступа: `chmod 644 cert.pem` и `chmod 600 key.pem`

### Ошибка: "Permission denied"
- Убедитесь, что nginx контейнер имеет доступ к файлам сертификатов
- Проверьте, что директория `nginx/ssl` существует и монтируется правильно

### Браузер не принимает self-signed сертификат
- Это нормально для self-signed сертификатов. Нажмите "Продолжить" или "Advanced" → "Proceed to [IP]"
- Self-signed сертификаты обеспечивают шифрование, но не проверяются доверенными центрами
- Для работы с доменом можно использовать Let's Encrypt, но для IP адресов это невозможно

## Безопасность

- **Никогда не коммитьте приватные ключи в Git!**
- Директория `nginx/ssl/` уже добавлена в `.gitignore`
- Используйте правильные права доступа к файлам (скрипт устанавливает их автоматически)
- Обновляйте сертификаты раз в год (или при смене IP адреса)
- Self-signed сертификаты обеспечивают шифрование трафика, но не проверяются браузерами автоматически

## Альтернативы

Если в будущем появится домен:
- Можно использовать Let's Encrypt для получения доверенных сертификатов
- Просто замените файлы в `nginx/ssl/` на сертификаты от Let's Encrypt
- Конфигурация nginx уже готова для работы с любыми SSL сертификатами

